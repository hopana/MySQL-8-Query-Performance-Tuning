# 查询调优方法

有几种方法可以解决问题。在极端情况下，你可以先潜入，尝试做一些改变。虽然这看起来像是节省时间，但更经常的是，它只能造成挫折感，即使这些变化似乎有效，您也不确定您是否真的解决了根本问题，或者问题暂时好转了。

相反，建议通过分析和使用监测来确认更改的效果，以方法论工作。本章将向您介绍一种在通过重点性能调优解决 MySQL 问题时非常有用的方法。首先介绍方法中的步骤。然后，本章的其余部分将更详细地讨论每个步骤，以及为什么花尽可能多的时间主动地进行工作很重要。

------

**注意**：此处描述的方法基于Oracle支持中用于解决客户报告的问题的方法。

------



## 总览

MySQL 性能调优可视为一个永无止境的过程，其中迭代建议用于随着时间的推移逐步提高性能。显然，有时会有特定问题，如查询需要半小时才能完成，但重要的是要记住，性能不是二进制状态，因此有必要知道什么是足够好的性能。否则，您甚至无法完成单个任务。

图 2-1 显示了如何描述性能调优生命周期的示例。循环从左上角开始，由四个阶段组成，其中第一个阶段是验证问题。

![](../附图/Figure%202-1.png)

当您遇到性能问题时，第一阶段是验证问题是什么，包括收集问题的证据，并定义什么要求来考虑问题已解决。

第二阶段涉及确定性能问题的原因，在第三阶段中，您可以确定解决方案。最后，在第四阶段，您实现解决方案。解决方案的实现应包括验证更改的效果。

------

**提示**：在危机期间进行救火和主动工作时，此循环均有效。

------

然后，您就可以从头做起，要么进行第二次迭代，以进一步提高刚刚关注的问题的运行性能，要么可能需要解决第二个问题。也可能在周期之间会有一段很长的时间。

## 验证问题

在尝试确定问题的原因和解决方案是什么之前，必须清楚您试图解决什么问题。说"MySQL 慢"是不够的—— 这是什么意思？一个特定的问题是，"前面网页第二部分使用的查询需要五秒钟"，或者"MySQL 只能维持 5000 个事务/秒"。您越具体，解决问题的机会就越大。

问题的定义还应包括验证问题是什么。问题一开始似乎是什么，真正的问题是什么，这两者之间是有区别的。验证问题可能很简单，只需执行查询并观察查询是否真正需要声称的时间，或者可能涉及检查您的监视。

准备工作还应包括从监视中收集基准或运行说明问题的数据集。如果没有基准，您可能无法证明在故障排除结束时已解决了问题。

最后，您需要确定性能调优的目标是什么。引用斯蒂芬 · 科维的《高效人士的习惯》

*开始就要考虑如何结束。*

慢查询的运行速度的最低可接受目标是什么？或者所需的最小事务吞吐量是多少？这将确保您知道在进行更改时是否达到了目标。

问题已明确定义和验证后，可以开始分析问题并确定原因。

## 确定原因

第二阶段是确定性能不佳的原因。确保你思路开放，并考虑整个堆栈，所以你最终不会盯着自己的盲目的一个方面，事实证明，没有任何与问题有关。

当你认为你知道原因时，你还需要争辩为什么这就是原因。EXPLAIN 语句的输出清楚地显示查询执行完整表扫描，因此这可能是原因，或者您可能有一个图形显示 InnoDB 重做日志已满 75%，因此您可能会出现异步刷新导致临时性能问题。

找出原因往往是调查最难的部分。一旦知道原因，您就可以决定解决方案。

## 确定解决方案

这是一个两步过程，用于确定您调查的问题的解决方案。第一步是找到可能的解决方案;其次，您必须选择要实现哪一个。

当你寻找可能的解决方案时，进行头脑风暴会很有用，你写下所有你能够想到的想法。重要的是，不要将自己限制在根本原因所在的狭窄区域，因为在尽可能多的地方可能找到其他区域的解决方案。例如，由于上一章中提到的内存碎片而导致的停滞，其中解决方案是更改 MySQL 的配置，以使用直接 I/O 来减少操作系统 I/O 缓存的使用。您还应同时考虑短期解决方法和长期解决方案，因为如果需要重新启动或升级 MySQL、更改硬件或类似解决方案，则可能并不总是能够立即实施完整解决方案。

------

**提示** 有时被低估的解决方案是升级 MySQL 或操作系统以访问新功能。但是，当然，您需要进行小心测试，以验证您的应用程序是否与新版本兼容，并特别小心优化器是否有任何更改会导致查询性能不佳。

------

确定解决方案的第二部分是选择最适合的候选解决方案。为了做到这一点，你必须争论每个解决方案为什么它的工作原理，什么是利弊。在这一步中，重要的是要对自己诚实，并小心地考虑可能的副作用。

一旦您充分了解所有可能的解决方案，您可以选择继续使用哪种解决方案。您还可以选择一个解决方案作为临时缓解措施，同时使用更可靠的解决方案。在这两种情况下，下一阶段是实现解决方案。

## 实施解决方案

通过一系列步骤实现解决方案，其中定义行动计划、测试行动计划、优化行动计划等，直到最终将解决方案应用于生产系统。重要的是不要急于这个过程，因为这是发现解决方案问题的最后机会。在某些情况下，测试可能还表明您需要放弃解决方案，回到上一个阶段并选择不同的解决方案。图 2-2 说明了实现解决方案的工作流。

![](../附图/Figure%202-2.png)

您采用选择的解决方案，并为其创建一个行动计划。在这里，非常具体非常重要，因此可以确保您测试的行动计划也是您最终应用于生产系统的行动计划。记下要使用的精确命令和语句可能很有用，因此可以复制和粘贴它们，或在脚本中收集它们，以便自动应用它们。

然后，您需要在测试系统上测试行动计划。重要的是，它反映生产尽可能密切。测试系统上的数据必须代表生产数据。实现此目的的一个方法是复制生产数据，可以选择使用数据掩蔽以避免将敏感信息（如个人详细信息和信用卡信息）从生产系统中复制出去。

------

**提示** MySQL 企业版订阅（付费订阅）包括数据掩www.mysql.com/products/enterprise/masking.html。

------

测试应验证该解决方案已解决问题，并且没有意外的副作用。需要测试取决于您试图解决的问题和建议的解决方案。如果查询速度较慢，则涉及在实现解决方案后测试查询的运行性能。如果修改索引器一个或多个表，还必须验证它如何影响其他查询。实施解决方案后，您还需要对系统进行基准测试。在所有情况下，都需要与问题验证期间收集的基线进行比较。

第一次尝试可能未完全如预期的那样工作。通常，只是对行动计划的一些改进是需要的，其他时候您可能必须完全放弃建议的解决方案，回到前一阶段，然后选择另一个解决方案。如果建议的解决方案部分解决了问题，您也可以选择将其应用于生产系统，然后返回起点并评估如何继续提高性能。

当您对测试显示解决方案有效时，您可以将它应用于暂存系统，如果所有系统仍在工作，则可将其应用于生产系统。完成操作后，再次需要验证其工作。无论您在设置代表生产系统的测试系统时有多小心，由于一个原因，解决方案在生产时不能完全像预期的那样工作。本书作者遇到的一个可能是，随机的索引统计信息是不同的，因此在生产系统上应用解决方案时，需要使用 ANALYZE TABLE 语句来更新索引统计。

如果解决方案有效，您应该收集一个新的基线，可用于将来的监视和优化。如果解决方案无法正常工作，则需要通过回滚更改和查找新解决方案或进行新一轮故障排除并确定解决方案为何不起作用并应用第二个解决方案来确定如何继续。

## 积极工作

性能调优是一个永无止境的过程。 如果您的系统从根本上来说是健康的，那么大部分工作都将在预防紧急情况和紧急程度相对较低的地方积极开展。 这不会给您的工作带来太多关注，但是它将使您的日常生活压力减轻，并且用户会更快乐。

------

**注意**：这一讨论在某种程度上基于斯蒂芬·科维的《高效人士7个习惯》中的习惯3"*把第一件事放在第一位*"。

------

图 2-3 显示了如何将任务分类为任务的紧急性及其重要。紧急任务通常受到其他人的注意，而其他任务可能很重要，但只有当它们没有在时间上完成时，它们才变得可见，因此它们突然变得紧迫。

![](../附图/Figure%202-3.png)

最容易分类的任务是那些与危机相关的任务，例如生产系统关闭，公司失去收入，因为客户不能使用产品或进行购买。这些任务既紧迫又重要。花很多时间在这些任务上可能会让你觉得重要，但它也是一种非常有压力的工作方式。

解决绩效问题最有效的方法就是解决重要而不是紧迫的问题。这是防止危机的主动工作，包括监测、在问题出现之前进行改进等等。此类别中的一个重要任务也是准备，因此您已经准备好处理危机了。例如，这可能是设置一个备用系统，在发生危机或过程时可以故障转移到该系统，以便快速启动替换实例。这可以帮助减少危机的持续时间，并把它带到重要，但不是酸涩的类别。您花在此类别中的任务上的时间越多，通常越成功

最后两个类别包括不太重要的任务。紧急但不太重要的任务示例包括无法重新安排的会议、其他人推动的任务，以及感知到的（但不是真的）危机。非刺激和非重要任务，包括管理任务和检查电子邮件。当然，其中一些任务对于您保住工作可能是必需的，而且非常重要，但它们对于保持MySQL的运行并不重要。虽然这些类别中始终存在必须处理的任务，但必须尽量减少在这里花费的时间。

避免处理非重要任务的一部分包括了解任务的重要性，例如，通过定义性能是否足够好，这样您最终不会过度优化查询或吞吐量。在实践中，如果非重要任务得到组织中其他人的注意（这些任务往往是紧急任务），那么当然很难推回这些任务，但重要的是，您必须尽可能多地将工作转移到重要但非紧急任务上，以避免以后接管危机任务。

## 总结

本章讨论了可用于解决 MySQL 性能问题（和其他类型的问题）的方法，以及主动工作的重要性。

报告问题时，您开始验证问题是什么，并确定问题已经解决。对于天性上是开放式的绩效问题，了解什么足够好很重要，否则您永远不会停止执行危机管理并回到主动工作。

一旦您有一个明确的问题描述，你可以工作，以确定的原因;一旦原因清楚，您可以确定要做什么来解决问题。最后一阶段是实施解决方案，如果事实证明您首先选择的解决方案不起作用或有不可接受的副作用，则可能需要您重新审视潜在的解决方案。在这方面，在尽可能逼真的设置中测试解决方案非常重要。

本章的最后一部分讨论了花费尽可能多的时间，以及可能做主动工作的重要性，这些工作可以防止危机的发生，并有助于在危机确实发生时做好准备。这将有助于你有一个压力较小的工作，并管理一个数据库在更好的健康。

正如本章所讨论的，在将解决方案部署到生产系统之前，测试解决方案的影响非常重要。下一章将重点介绍 Sysbench 基准的基准测试。