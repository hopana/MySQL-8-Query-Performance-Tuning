# 使用Sysbench进行基准测试

在将更改应用于生产系统之前，验证更改的影响非常重要。这适用于修改查询和大型更改（如重构应用程序和架构以及 MySQL 升级）等小更改。您可能认为最佳性能测试基于使用应用程序执行的相同查询的生产架构和数据。但是，它并不总是简单的，因为它听起来要重新创建正确的工作负载，所以有时有必要使用标准基准套件。

本章首先介绍执行基准测试时的一些最佳实践，以及对 MySQL 中使用的一些最常见的基准和工具的浏览。然后，将更详细地考虑最常用的基准基准的Sysbench。

## 最佳实践

安装基准程序并执行它很容易。困难的部分是使用它的权利。执行 MySQL 基准测试共享性能调整的一些概念，第一点也是最重要的一点是，您需要以"知情的方式"工作。这意味着您必须很好地了解您的工具，并清楚地定义测试的目标和成功标准。对于工具，您需要知道如何正确使用它们，因为使用默认参数执行它们可能不会生成所需的测试。

这与基准的目标联系在一起。您需要确定什么？例如，您可能希望验证更改某些配置变量的效果，在这种情况下，必须确保已设置测试，以便测试区域。请考虑一个选项，例如innodb_io_capacity InnoDB 写入的速度。如果您的基准测试是只读测试，innodb_io_capacity更改不会产生任何影响。在此上下文中，您还需要确保一次只更改一件事，并且只进行相对较小的更改，就像在更改生产系统时应该进行一样。否则，如果同时更改多个设置，则某些设置可能会对结果做出积极贡献，而另一些设置则具有相反性，但您无法确定要保留哪些更改以及哪些更改。如果做出较大更改，可能会超过最佳值，因此，即使还有改进的余地，您最终还是将更改终止。

在测试结束时读取结果时，您需要了解标位测量结果;否则，结果只是一个毫无意义的数字。这还包括定义在测试期间要调整的变量，对于一般的性能调整，保持变量数量限制非常重要，因此您可以轻松地确定每个变量的效果。为了使结果有效，您还必须确保测试是可重复的，也就是说，如果执行同一测试两次，则得到相同的结果。测试可重复的一个要求是，您具有定义的系统的起始状态。

**提示 不要假定一个客户端足以生成您瞄准的负载。需要多少个客户端取决于并发查询的数量和要执行的基准。**

这就引了下一个要点。基准应反映应用程序的工作负载。如果应用程序具有联机分析处理 （OLAP） 工作负载，或者如果应用程序写入量过大，则它可以帮助您使用联机事务处理 （OLTP） 基准来证明您的配置更改工作得非常有效。

您可能认为设计基准的最佳方法是捕获生产中执行的所有查询，并重播它们作为基准。这肯定有一些缺点，但也有挑战。收集执行的所有查询的成本很高，但是，如果您已经启用了 MySQL 企业审核日志以用于审核目的，可以使用该日志。将生产数据复制到测试系统也可能有数据隐私问题。最后，与当前生产负载相比，很难扩展测试以更改数据集的大小（无论是向下使其更易于管理还是可测试增长）。出于这些原因，通常有必要使用人工基准。

**提示 您可以使用 MySQL 企业审核日志（需要订阅）或一般查询日志（非常高的开销）来捕获一段时间内的所有查询。这包括执行查询时的时间戳，因此您可以使用日志以相同的并发顺序重新播放查询。但是，您需要自己创建一个脚本来提取查询并执行它们。**

下一点是关于与前一点相关的基准结果。当您获得基准测试结果时，了解结果的含义非常重要，并且不要仅仅因为结果看起来错误而放弃结果。阿苏克，基准结果是"永不错误";这是一些工作的结果。如果结果没有结果，那么了解结果为何会这样，是一点。也许，您没有使用您预期的参数或使用的参数大小与预期不同，但也可能有其他内容干扰基准，或者第三个参数。如果某样东西干扰了基准，那么在生产中是否也会发生这种事情？如果可以，那么基准非常相关，您需要决定在生产中如何处理此类情况。

要了解基准测试期间发生的情况，监视 MySQL 和主机系统也很重要。一种选择是使用与用于生产系统相同的监控解决方案。但是，测试或开发系统的基准测试与生产系统有点不同，因为您通常对高频采样不感兴趣，但在基准测试期间持续时间较短，因此使用专用的基准监控解决方案非常有用。其中一个选项dim_STAT由 DimitriKravtchuk 开发的 http://dimitrik.free.fr/（http://dimitrik.free.fr/），他是 MySQL 的性能架构师，并且是许多 MySQL 服务器基准测试的幕后黑手。

一般来说，了解结果不是一件简单的事情。还有一件事你需要注意的是，如果有一个临时摊位，在基准期间会发生什么。座标是保留后续查询，还是继续提交查询？如果保留，则后续查询实际上将比实际世界中的查询快，因为用户不会仅仅因为存在积压而停止提交请求。

最后，基准测试通常生成多个指标，因此您需要分析结果，因为它对您的系统最相关。例如，延迟还是直通输出是最重要的？或者你们对两者都有要求吗？还是你更对第三个指标更不感兴趣？

## 标准TPC基准

有一个几乎没完没了的基准列表，但最终那些通常使用的测试归结为少数的测试。这并不意味着您不应考虑其他基准;最后重要的是基准适用于您的要求。

最常用的标准基准由 TPC （www.tpc.org/） 定义，新的基准被设计为硬件和软件更改，使得老基准太简单。TPC网站包括基准的详细描述和规格。表 3-1 总结了当前企业 TPCbenchmark。

补充表3-1

这些标准基准的优点是，您更有可能找到实现它们工具，并且可以与其他人员获得的结果进行比较。

**提示 如果您想了解有关 TPC 基准以及如何以最佳方式执行数据库基准测试，请考虑 Bert Scalzo：数据库基准和压力测试 （Apress） www.apress.com/gp/book/9781484240076。**

与有标准基准一样，也有一些通用的基准标记工具。

## 通用基准工具

实现基准远不是微不足道的，因此在大多数情况下，首选使用可执行基准测试的基准工具。有些工具是跨平台和/或可以使用几个不同的数据库系统，而其他工具则更具体。您应该选择实现所需的基准的基准，并处理您拥有生产系统的平台上。

